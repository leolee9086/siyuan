# AI聊天功能开发笔记

## 这个区段由开发者编写,未经允许禁止AI修改

开发者要求实现基于思源笔记Protyle编辑器的AI聊天功能，包括：
1. 流式AI响应
2. 聊天面板不自动关闭
3. 上下文动态更新
4. 追加到笔记按钮

## 修改记录

### 2025-01-17 修复追加到笔记按钮失效问题

**问题**: 用户反馈追加到笔记按钮似乎失效了。

**分析**: 
- 在流式响应过程中，代码试图保留追加按钮，但更新文本内容的方式有问题
- 直接操作DOM的文本节点可能会破坏DOM结构
- 追加按钮的事件监听器可能在DOM更新过程中丢失
- 调用`fillContent`时传入空数组导致`elements[elements.length - 1]`为undefined

**解决方案**:
1. 创建专门的`updateAIMessageContent`函数来处理AI消息内容更新
2. 在更新内容时保留追加按钮的DOM结构
3. 确保追加按钮的事件监听器在内容更新后仍然有效
4. 修复`fillContent`调用时传入正确的elements参数

**修改内容**:
- 添加`updateAIMessageContent`函数，专门处理AI消息内容更新
- 在流式响应、错误处理和终止响应时都使用这个函数
- 确保追加按钮在内容更新过程中不被破坏
- 重新绑定追加按钮的事件监听器
- 修复`appendToNote`函数，获取当前文档的最后一个块作为插入位置

**技术要点**:
- 使用`innerHTML = ''`清空内容区域，然后重新构建
- 保留追加按钮的DOM结构或重新创建
- 确保事件监听器在内容更新后仍然有效
- 统一处理所有AI消息内容更新的场景
- 使用`protyle.wysiwyg.element.querySelectorAll('[data-node-id]')`获取所有块
- 使用最后一个块作为`fillContent`的插入位置

### 2025-01-17 添加上下文控制开关功能

**问题**: 用户反馈选中块数量显示正确，但发送的上下文不对，需要添加开关来控制发送内容。

**分析**: 
- 当有选中块时，用户需要选择是发送全笔记还是只发送选中的块
- 需要添加一个开关来控制这个行为
- 开关只在有选中块时显示

**解决方案**:
1. 在有选中块时显示"发送全笔记"开关
2. 开关开启时发送全笔记但强调选中的块
3. 开关关闭时只发送选中的块内容
4. 动态显示/隐藏开关

**修改内容**:
- 在上下文信息区域添加复选框开关
- 修改`getContextInfo`函数，添加获取选中块内容的功能
- 更新`sendMessage`函数，根据开关状态决定发送的上下文
- 修改`updateContextInfo`函数，动态管理开关显示

**技术要点**:
- 开关只在有选中块时显示，无选中块时自动隐藏
- 优先级：文字选择 > 块选择 > 全笔记
- 开关开启时发送全笔记但特别强调选中的块
- 开关关闭时只发送选中的块内容

### 2025-01-17 修复选中块识别问题

**问题**: 用户反馈`protyle-wysiwyg--select`选中的块没有被正确识别，始终显示的是块总数。

**分析**: 
- `getContextInfo`函数中的`selectedBlocks`计算逻辑有误
- 原代码使用`window.getSelection().rangeCount > 0`作为条件，但这个条件总是为true
- 应该直接查询`.protyle-wysiwyg--select`类的元素数量

**解决方案**:
1. 修复`selectedBlocks`的计算逻辑，直接查询选中的块
2. 更新上下文显示逻辑，优先显示选中内容，其次显示选中块，最后显示总块数
3. 确保选中块数量能正确反映在界面上

**修改内容**:
- 修复`getContextInfo`函数中的`selectedBlocks`计算
- 更新`createChatHTML`和`updateContextInfo`函数的显示逻辑
- 添加`hasSelectedBlocks`判断，优先显示选中块信息

**技术要点**:
- 使用`protyle.wysiwyg.element.querySelectorAll('.protyle-wysiwyg--select').length`获取选中块数量
- 优先级：选中内容 > 选中块 > 总块数
- 确保界面实时反映选择状态变化

### 2025-01-17 修复聊天界面聚焦导致取消块选择的问题

**问题**: 用户反馈聊天界面的聚焦会触发取消块选择，导致上下文信息丢失。

**分析**: 
- Protyle监听了`focusout`事件，当焦点从编辑器转移到聊天界面时会触发
- `hideElements(["select"], protyle)`函数会清除所有`protyle-wysiwyg--select`类
- 聊天界面的输入框、按钮等元素聚焦时会触发Protyle的focusout事件

**解决方案**:
1. 监听Protyle的`focusout`事件，检查焦点转移目标
2. 如果焦点转移到聊天界面，阻止事件传播和默认行为
3. 确保块选择状态在聊天界面聚焦时保持不变

**修改内容**:
- 添加`preventFocusoutClearSelection`函数处理focusout事件
- 检查`event.relatedTarget`是否在聊天面板内
- 如果是聊天界面聚焦，阻止事件传播
- 在面板销毁时正确清理事件监听器

**技术要点**:
- 使用`event.stopPropagation()`和`event.preventDefault()`阻止事件
- 使用`addEventListener`的第三个参数`true`确保在捕获阶段处理
- 正确清理事件监听器避免内存泄漏

### 2025-01-17 修复Protyle选择监听机制

**问题**: 用户反馈上下文未随选择变化更新，需要正确监听Protyle的块选择和文字选择。

**分析**: 
- Protyle使用`protyle-wysiwyg--select`类来标记选中的块
- 需要区分块选择和文字选择的不同监听方式
- 文字选择不需要使用document上的事件实现

**解决方案**:
1. 使用MutationObserver监听`protyle-wysiwyg--select`类的变化来检测块选择
2. 监听`selectionchange`事件但只处理Protyle内的文字选择
3. 优化监听逻辑，避免频繁触发

**修改内容**:
- 添加`blockSelectionObserver`监听块选择变化
- 优化`handleTextSelectionChange`只处理Protyle内的文字选择
- 修复面板销毁时的清理逻辑

**技术要点**:
- MutationObserver监听DOM变化，包括class属性变化和子节点变化
- 区分块选择和文字选择的不同处理方式
- 使用防抖机制避免频繁更新

### 2025-01-17 修复缩回按钮图标和追加按钮显示

**问题**: 
1. 缩回按钮图标不正确
2. 追加按钮在流式响应时被覆盖
3. 面板销毁时事件监听器未正确清理

**解决方案**:
1. 修正缩回按钮图标为`iconDown`和`iconUp`
2. 改为只更新文本节点内容，保留追加按钮
3. 通过公共方法设置销毁回调并清理事件监听

### 2025-01-17 修复面板高度调节问题

**问题**: 自定义面板容器有固定高度，导致面板高度调节失效。

**解决方案**: 移除自定义面板容器的固定高度，让面板高度由各自控制。

### 2025-01-17 实现自定义面板系统

**功能**: 设计并实现了Protyle的自定义面板系统，支持：
- 多面板管理
- 调节手柄
- 缩回按钮
- 插件扩展

**技术实现**:
- 替代原有Dialog实现
- 支持面板高度调节
- 添加缩回/展开功能
- 按钮图标动态切换

### 2025-01-17 修复运行时方法绑定问题

**问题**: `addCustomPanel`方法未正确绑定到Protyle实例上。

**解决方案**: 将方法正确添加到Protyle实例上，确保运行时可用。

## 技术架构

### 自定义面板系统
- 支持多面板同时显示
- 面板高度可调节
- 支持缩回/展开功能
- 插件化设计，易于扩展

### 选择监听机制
- 块选择：通过MutationObserver监听`protyle-wysiwyg--select`类变化
- 文字选择：监听`selectionchange`事件，只处理Protyle内变化
- 防抖机制避免频繁更新
- 防止聊天界面聚焦时取消块选择
- 正确识别和显示选中块数量

### 上下文控制功能
- 动态显示"发送全笔记"开关
- 开关开启时发送全笔记但强调选中块
- 开关关闭时只发送选中块内容
- 优先级：文字选择 > 块选择 > 全笔记

### 流式响应处理
- 支持实时显示AI响应
- 保留追加按钮不被覆盖
- 优化用户体验

## 待优化项目

1. 考虑添加面板拖拽功能
2. 优化面板样式和动画效果
3. 添加更多AI功能（如代码解释、翻译等）
4. 考虑添加面板配置保存功能 